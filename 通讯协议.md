#### 客户端

* 为方便文档描述, 在打洞过程各角色称呼如下:
	* 服务端程序: 服务器
	* 主动发起打洞的客户端A: 主叫
	* A想连接到的远程客户端B: 被叫

* 基本通讯字段说明

	字段 | 类型 | 说明
	--- | --- | ---
	t | int | 消息类型, 请求方传入, 响应方取 -t 返回
	mid | long | 消息id, 请求方传入, 响应方原样返回
	code | int | 状态码, 200为响应成功, 否则则为响应失败
	em | string | 错误信息, code不为200的时候有值, 否则为null
	extra | jsonobject | 数据, code为200的时候有值, 否则为null
	
* 主叫向服务器发起请求, 想和被叫建立连接

	* 主叫 -> 服务器
	
			{
				"t":4,
				"mid": 123456789,
				"ltag":"主叫的标签",
				"extra":{
					"rtag":"被叫的标签",
				}
			}
	* 服务器 -> 主叫
	
			{
				"t":-4,
				"mid":123456789,
				"code":200,
				"em":"",
				"extra":{
					"token":"服务器生成的token"
				}
			}
	* 字段说明:
		
		字段 | 类型 |说明
		---|---|---
		ltag | string | 主叫标签
		rtag | string | 被叫的标签
		port | int | 主叫准备开放的端口
		token | string | 服务器生成的的token
	* 接口说明
	
		1. 主叫向服务器发起请求连接被叫
		2. 服务器查询被叫是否在线(存在)
			- 2.1 在线, 则反馈给主叫可以并且服务器正在连接被叫;
			- 2.2 不在线, 则返回数据表示远程不可连接
		3. 注意: 主叫发起打洞的时候, 只需要创建一个udp socket, 然后使用这个socket发送打洞请求信息给服务器, 因为局域网创建并绑定的端口, 再经过路由器后, 可能已经被路由器替换成别的端口了

* 服务器通知被叫有打洞请求
	
	* 服务器 -> 被叫

			{
				"t":10,
				"mid":123456789,
				"extra":{
					"token":""
					"host":"",
					"port":12345
				}
			}

	* 被叫 -> 服务器
			
			{
				"t":-10,
				"mid":123456789,
				"token":"",
				"code":200,
				"em":"",
				"extra":{
					"port":54321
				}
			}
	* 字段说明
	
		字段 | 类型 | 说明
		--- | --- | ---
		token | string | 打洞信令, 服务器根据主叫和被叫生成的字符串
		host | string | 主叫的公网ip
		port | int | 主叫或被叫准备开放的端口
		
	* 接口功能说明:
		1. 被叫在响应服务器的请求后, 根据所收到的主叫的公网ip和端口, 往这个目标发送报文(但是这个报文主叫不会收到, 其作用只是在路由上打开了允许主叫访问本端口的映射);
		2. 将本地开放的端口反馈给服务器, 
		3. 服务器收到被叫的反馈后, 获取端口和被叫的公网ip, 传给主叫
		4. 主叫在收到被叫开放的端口和公网ip后, 发送udp报文给被叫
		5. 被叫在收到udp报文后, 启动TCP server(绑定被叫开放的端口), 然后将报文发送还给主叫, 表示被叫已准备好, 可以被连接了;
		6. 主叫收到被叫的反馈报文后, 启用TCP去连接远程
		7. 打洞成功

* 服务器通知主叫被叫的响应信息
	
	* 服务器 -> 主叫
	
			{
				"t":11,
				"mid":1234567890,
				"token":"",
				"code":200,
				"em":"",
				"extra":{
					"host":"",
					"port":23456
				}
			}
	* 主叫 -> 服务器
		
			{
				"t":-11,
				"mid":1234567890,
				"token":"";
			}
	* 字段说明:

#### 主叫 <-> 被叫

* 通信步骤
	* 被叫收到来自服务器的打洞通知, 被叫向主叫指定开放的端口发送报文, 报文会被丢弃, 但是会打开允许主叫端口+外围ip呼入的映射;
	* 主叫收到服务器通知的被叫的反馈, 主叫会朝着被叫的开放端口发送报文
	
* 被叫打洞: 报文会被丢弃, 但是也会生成允许主叫连接进入的映射, 所以这里主叫没有反馈
	* 被叫 -> 主叫:

			{
				"t":30
			}

* 主叫尝试打洞 + 心跳
	* 主叫 -> 被叫

			{
				"t":31,
				"mid":12345678,
				"token":"信令"
			}
	* 被叫 -> 主叫
	
			{
				"t":-31,
				"mid":12345678,
				"token":""
			}

* 主叫连接tcp

	* 主叫 -> 被叫
		
			{
				"t":32,	
				"mid":12345678,
				"token":"",
				"extra":{
					"op":1,
				}
			}
	* 被叫 -> 主叫
			
			{
				"t":-32,
				"mid":12345678,
				"token":"",
				"code":200,
				"em":"",
				"extra":{
					"conkey":"";
				}
			}
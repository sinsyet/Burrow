#### 通信协议列表

1. 客户端注册
	- 1.1 客户端请求服务器
	- 1.2 服务器反馈一个生成的tag
2. 客户端往服务端发送心跳
	- 2.1 客户端携带tag请求服务器, 表示自己还 "活着" 
	- 2.2 服务器记录客户端还 "活着", 反馈心跳成功
3. 客户端获取其他在线的客户端
	- 3.1 客户端携带tag请求服务器, 获取其他在线的客户端
	- 3.2 服务器返回其他在线客户端的tag 
4. 客户端发起打洞
	- 4.1 客户端A携带自身tag和远程客户端B的tag, 发起打洞行为
	- 4.2 服务器验证客户端A的tag是否合法, 验证远程客户端B是否存在, 返回是否可以打洞, 如果可以打洞, 则返回一个token, 表示打洞行为;
5. 服务器通知客户端B, 客户端A要连接客户端B
	- 5.1 如果4.2中验证客户发起打洞, 则服务器会告知客户端B, 客户端A想连接你, 并告知客户端B客户端用于打洞使用的端口+公网IP;
	- 5.2 客户端B收到打洞通知后, 会本地专用于打洞的端口回复到服务端, 客户端获取到客户端B的公网IP和专用于打洞的端口映射后的端口;
6. 服务器通知客户端A, 客户端B的打洞响应
	- 6.1 服务器在收到5.2中客户端B收到的打洞反馈后, 获取客户端的公网IP和映射端口, 传给客户端A的打洞端口;
	- 6.2 客户端A反馈已收到
7. 客户端B尝试连接客户端A
	- 7.1 客户端B在经过5.1后, 会朝着客户端A用于打洞的公网IP和端口发送报文, 用于打开客户端A和B的端口映射
	 
8. 客户端A连接客户端B
	- 8.1 客户端A在6.2后会朝着客户端B发送打洞报文
	- 8.2 客户端B反馈客户端B打洞成功;
	
9. 客户端A通过TCP连接客户端B(执行到这步后已经打洞成功)

10. 服务器发送消息到客户端A和B询问是否仍然在打洞;
	- 10.1 服务端往客户端A发送消息
	- 10.2 客户端A回复到服务端
	- 10.3 服务端往客户端B发送消息
	- 10.3 客户端B回复到服务端
	
#### 工作原理

* 服务器:
	* 监听两个UDP端口, 其中
		* 端口1: 暴露在公网上, 供客户端注册(1.2), 心跳(2.2), 获取其他在线客户端(3.2), 响应打洞(4.2); 这个端口只响应客户端的请求; 
		* 端口2: 随机使用的端口, 主要用于通知客户端A(5.1)和客户端B(6.1), 询问打洞情况(10.1, 10.3), 
	
* 客户端:
	* 监听2个UDP端口, 一个TCP端口, 其中
		* UDP端口1: 用于连接服务器的端口1, 用于注册(1.1), 心跳(2.2), 获取其他在线客户端(3), 被通知打洞(5), 等操作;
		* UDP端口2: 用于配合打洞, 用于响应被通知打洞(5),


#### 详细协议

* 在打洞过程各角色称呼如下:
	* 服务端程序: 服务器
	* 主动发起打洞的客户端A: 主叫
	* A想连接到的远程客户端B: 被叫

----------

* 基本通讯字段说明

	字段 | 类型 | 说明
	--- | --- | ---
	t | int | 消息类型, 请求方传入, 响应方取 -t 返回
	mid | long | 消息id, 请求方传入, 响应方原样返回
	code | int | 状态码, 200为响应成功, 否则则为响应失败
	em | string | 错误信息, code不为200的时候有值, 否则为null
	extra | json object | 数据, code为200的时候有值, 否则为null
	params | json object | 请求参数

* 响应成功和失败基本格式
	* 响应 '成功' 内容:
		
			{
				"t":-reqT,			// 返回请求t的相反数
				"mid":reqMid,		// 原样返回请求的mid
				"code":200,			// 状态码为200表示响应成功
				"extra":{			// code为200的时候extra可能有值
					...
				}
			}

	* 响应 '失败' 内容
	
			{
				"t":reqT,
				"mid":reqMid,
				"code":20x,			// 非200, 不同的状态码表示不同的意思
				"em":""				// error msg, 错误信息, 和code是对应的
			}

----------

* 客户端注册
	* 客户端 -> 服务器
	
			{
				"t":1,
				"mid":1234567890
			}
	* 服务器 -> 客户端
	
			{
				"t":-1,
				"mid":1234567890,
				"extra":{
					"tag":""
				}
			}
	* 字段说明:
	
		字段 | 类型 | 说明
		---|---|---
		tag | string | 客户端注册后服务器生成的tag, 表示客户端
	
* 客户端心跳
	* 客户端 -> 服务器
	
			{
				"t":2,
				"tag":""
			}
	* 服务器:
	
			{
				"t":-2,
			}

* 客户端获取其他在线的设备
	* 客户端 -> 服务器
		
			{
				"t":3,
				"mid":1234567890,
				"params":{
					"tag":"tag",
				}
			}
	* 服务器 -> 客户端
		
			{
				"t":-3,
				"mid": 1234567890,
				"extra":{
					"tags":[]
				}	
			}
	* 字段说明
	
		字段 | 类型 | 说明
		---|---|---
		tag | string | 注册成功后服务器分配的tag
		tags | json array | 所有在线的客户端的标签(不包含自己的标签)

* 主叫向服务器发起请求, 想和被叫建立连接

	* 主叫 -> 服务器
	
			{
				"t":4,
				"mid": 123456789,
				"params":{
					"tag":"主叫的标签"
					"rtag":"被叫的标签",
				}
			}
	* 服务器 -> 主叫
	
			{
				"t":-4,
				"mid":123456789,
				"code":200,
				"extra":{
					"token":"服务器生成的token"
				}
			}
	* 字段说明:
		
		字段 | 类型 |说明
		---|---|---
		tag | string | 主叫标签
		rtag | string | 被叫的标签
		token | string | 服务器生成的的token
	
* 服务器通知被叫有打洞请求
	
	* 服务器 -> 被叫

			{
				"t":51,
				"mid":123456789,
				"token":"",
				"params":{
					"ltag":""
					"host":"",
					"port":12345
				}
			}

	* 被叫 -> 服务器
			
			{
				"t":-51,
				"mid":123456789,
				"token":"",
				"code":200,
			}
	* 字段说明
	
		字段 | 类型 | 说明
		--- | --- | ---
		token | string | 打洞信令, 服务器根据主叫和被叫生成的字符串
		host | string | 主叫的公网ip
		port | int | 主叫在公网上的端口
		
	* 接口功能说明:
		1. 被叫回复的时候是使用专用于配合打洞的端口回复的, 
		2. 被叫用于打洞的映射端口和公网IP由服务器获取

* 服务器通知主叫被叫的响应信息
	
	* 服务器 -> 主叫
	
			{
				"t":52,
				"mid":1234567890,
				"token":"",
				"extra":{
					"rhost":"",
					"rport":23456
				}
			}
	* 主叫 -> 服务器
		
			{
				"t":-52,
				"mid":1234567890,
				"token":"";
			}
	* 字段说明:
	
		字段 | 类型 | 说明
		---|---|---
		rhost | string | 被叫的公网IP
		rport | int | 被叫用于打洞的在公网上的额映射端口


----------

* 客户端B尝试连接客户端A

	* 通信步骤
		* 被叫收到来自服务器的打洞通知, 被叫向主叫指定开放的端口发送报文, 报文会被丢弃, 但是会打开允许主叫端口+外围ip呼入的映射;
		* 主叫收到服务器通知的被叫的反馈, 主叫会朝着被叫的开放端口发送报文
	
	* 被叫 -> 主叫:

			{
				"t":101
			}

* 主叫尝试打洞 + 心跳
	* 主叫 -> 被叫

			{
				"t":102,
				"mid":12345678,
				"params"{
					"token":"信令"
				}
			}
	* 被叫 -> 主叫
	
			{
				"t":-103,
				"mid":12345678,
				"token":""
			}

